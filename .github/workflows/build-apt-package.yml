name: Build APT Package
permissions:
  id-token: write
  contents: write
  pages: write
on:
  workflow_dispatch:
  push:
    branches: [main]
    paths:
      - packaging/**
      - bash/debian/**
      - bash/common/**
      - .github/workflows/build-apt-package.yml
      - '!**/*.md'
      - '!.gitignore'
  pull_request:
    branches: [main]
    paths:
      - packaging/**
      - bash/debian/**
      - bash/common/**
      - '!**/*.md'
      - '!.gitignore'
env:
  PACKAGE_NAME: pds
jobs:
  version:
    name: Determine Version
    runs-on: ubuntu-latest
    outputs:
      semVer: ${{ steps.gitversion.outputs.semVer }}
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0 # GitVersion needs full history
      - name: Tag with GitVersion
        id: gitversion
        uses: michielvha/gitversion-tag-action@v6
        with:
          configFilePath: gitversion.yml # Path to your GitVersion config file
  lint:
    name: Lint Scripts
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6
      - name: Install shellcheck
        run: sudo apt-get update && sudo apt-get install -y shellcheck
      - name: Run shellcheck
        run: |
          cd packaging
          make lint
  build:
    name: Build Package
    runs-on: ubuntu-latest
    needs: [version, lint]
    strategy:
      matrix:
        arch: [all]
    steps:
      - name: Checkout
        uses: actions/checkout@v6
      - name: Set up environment
        run: |
          # Use GitVersion determined version
          VERSION="${{ needs.version.outputs.semVer }}"
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "Building version: $VERSION"
      - name: Install nfpm
        run: |
          echo 'deb [trusted=yes] https://repo.goreleaser.com/apt/ /' | sudo tee /etc/apt/sources.list.d/goreleaser.list
          sudo apt update
          sudo apt install nfpm
      - name: Update package version
        run: |
          cd packaging
          sed -i "s/version: .*/version: ${{ env.VERSION }}/" nfpm.yaml
          sed -i "s/VERSION := .*/VERSION := ${{ env.VERSION }}/" Makefile
          # Create VERSION file for runtime version detection
          mkdir -p usr/share/pds
          echo "${{ env.VERSION }}" > usr/share/pds/VERSION
      - name: Build package
        run: |
          cd packaging
          chmod +x build.sh
          ./build.sh build
      - name: Test package
        run: |
          cd packaging
          make test
      - name: Upload package artifact
        uses: actions/upload-artifact@v6
        with:
          name: ${{ env.PACKAGE_NAME }}-${{ needs.version.outputs.semVer }}-${{ matrix.arch }}
          path: packaging/dist/*.deb
          retention-days: 30
      - name: Show package info
        run: |
          cd packaging
          echo "Package built:"
          ls -la dist/
          echo
          echo "Package contents (first 20 files):"
          dpkg-deb -c dist/*.deb | head -20
  test-install:
    name: Test Installation
    runs-on: ubuntu-latest
    needs: [version, build]
    strategy:
      matrix:
        ubuntu-version: [22.04, 24.04]
    steps:
      - name: Download package
        uses: actions/download-artifact@v7
        with:
          name: ${{ env.PACKAGE_NAME }}-${{ needs.version.outputs.semVer }}-all
          path: ./packages
      - name: Test installation on Ubuntu ${{ matrix.ubuntu-version }}
        run: |
          docker run --rm -v $(pwd)/packages:/packages ubuntu:${{ matrix.ubuntu-version }} /bin/bash -c "
            apt-get update &&
            apt-get install -y /packages/*.deb &&
            echo 'Testing PDS installation...' &&
            pds doctor &&
            pds info &&
            echo 'Installation test passed on Ubuntu ${{ matrix.ubuntu-version }}'
          "
  release:
    name: Create Release
    runs-on: ubuntu-latest
    needs: [version, build, test-install]
    if: github.ref == 'refs/heads/main' && (github.event_name == 'push' || github.event_name == 'workflow_dispatch')
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v6
      - name: Set version
        run: |
          VERSION="${{ needs.version.outputs.semVer }}"
          echo "VERSION=$VERSION" >> $GITHUB_ENV
      - name: Download package
        uses: actions/download-artifact@v7
        with:
          name: ${{ env.PACKAGE_NAME }}-${{ needs.version.outputs.semVer }}-all
          path: ./release
      - name: Generate release notes
        run: |
          # Use template file and substitute variables
          sed -e "s|{{VERSION}}|${{ env.VERSION }}|g" \
              -e "s|{{REPOSITORY}}|${{ github.repository }}|g" \
              -e "s|{{PACKAGE_NAME}}|${{ env.PACKAGE_NAME }}|g" \
              .github/templates/release-notes.md > release-notes.md
      - name: Create Release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release create ${{ env.VERSION }} \
            --title "PDS ${{ env.VERSION }}" \
            --notes-file release-notes.md \
            ./release/${{ env.PACKAGE_NAME }}_${{ env.VERSION }}_all.deb

  deploy-apt-repo:
    name: Deploy APT Repository
    runs-on: ubuntu-latest
    needs: [version, release]
    if: github.ref == 'refs/heads/main' && (github.event_name == 'push' || github.event_name == 'workflow_dispatch')
    permissions:
      contents: read
      pages: write
      id-token: write
    steps:
      - name: Checkout
        uses: actions/checkout@v6
      - name: Set version
        run: |
          VERSION="${{ needs.version.outputs.semVer }}"
          echo "VERSION=$VERSION" >> $GITHUB_ENV
      - name: Install aptly
        run: |
          sudo apt-get update
          sudo apt-get install -y aptly gpg
      - name: Setup GPG key
        id: gpg
        run: |
          mkdir -p ~/.gnupg
          chmod 700 ~/.gnupg
          
          # Configure GPG for non-interactive batch mode
          echo "batch" > ~/.gnupg/gpg.conf
          echo "pinentry-mode loopback" >> ~/.gnupg/gpg.conf
          
          echo "Importing GPG private key from secret"
          echo "${{ secrets.GPG_PRIVATE_KEY }}" | gpg --batch --import
          
          # Export public key in binary format (.gpg extension requires binary, not armored)
          gpg --export > /tmp/pds-repo.gpg
          echo "GPG key fingerprint:"
          gpg --list-secret-keys --keyid-format LONG | grep -E "^(sec|ssb)"
      - name: Restore aptly cache
        id: cache
        uses: actions/cache@v5
        with:
          path: ~/.aptly
          key: aptly-repo-${{ runner.os }}-${{ github.repository }}
      - name: Rebuild repository from releases (if cache missing)
        if: steps.cache.outputs.cache-hit != 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Cache not found, rebuilding repository from all GitHub releases"
          
          # Initialize aptly
          aptly repo create -distribution=stable -component=main pds || true
          
          # Download all .deb files from releases
          mkdir -p /tmp/releases
          
          # Get all releases with .deb files
          gh release list --limit 100 --json tagName,assets | \
            jq -r '.[] | select(.assets[]?.name | endswith(".deb")) | .tagName' | \
            while read -r tag; do
              echo "Downloading packages from release $tag"
              gh release download "$tag" --pattern "*.deb" --dir /tmp/releases || true
            done
          
          # Add all packages to repository
          if [ -n "$(ls -A /tmp/releases/*.deb 2>/dev/null)" ]; then
            aptly repo add pds /tmp/releases/*.deb || true
            echo "Added packages from releases to repository"
          else
            echo "No packages found in releases, starting with empty repository"
          fi
          
          # Publish repository
          if [ -n "${{ secrets.GPG_PASSPHRASE }}" ]; then
            aptly publish repo -distribution=stable -architectures=all -batch=false -passphrase="${{ secrets.GPG_PASSPHRASE }}" pds || aptly publish update -batch=false -passphrase="${{ secrets.GPG_PASSPHRASE }}" stable || true
          else
            aptly publish repo -distribution=stable -architectures=all -batch=false pds || aptly publish update -batch=false stable || true
          fi
      - name: Download new package
        uses: actions/download-artifact@v7
        with:
          name: ${{ env.PACKAGE_NAME }}-${{ needs.version.outputs.semVer }}-all
          path: ./packages
      - name: Add package to repository
        run: |
          # Create repository if it doesn't exist
          aptly repo create -distribution=stable -component=main pds || true
          
          # Add new package
          aptly repo add pds ./packages/*.deb
          
          # Show repository contents
          echo "Repository contents:"
          aptly repo show -with-packages pds
      - name: Publish repository
        run: |
          # Publish or update repository
          if aptly publish list | grep -q "stable"; then
            echo "Updating existing publication"
            if [ -n "${{ secrets.GPG_PASSPHRASE }}" ]; then
              aptly publish update -batch=false -passphrase="${{ secrets.GPG_PASSPHRASE }}" stable
            else
              aptly publish update -batch=false stable
            fi
          else
            echo "Creating new publication"
            if [ -n "${{ secrets.GPG_PASSPHRASE }}" ]; then
              aptly publish repo -distribution=stable -architectures=all -batch=false -passphrase="${{ secrets.GPG_PASSPHRASE }}" pds
            else
              aptly publish repo -distribution=stable -architectures=all -batch=false pds
            fi
          fi
          
          # Export GPG public key to repository root
          cp /tmp/pds-repo.gpg ~/.aptly/public/pds-repo.gpg
          
          # Show published repository
          echo "Published repository structure:"
          ls -la ~/.aptly/public/
      - name: Prepare GitHub Pages
        run: |
          # Create pages directory structure
          mkdir -p pages/apt
          
          # Copy aptly public directory to pages/apt
          cp -r ~/.aptly/public/* pages/apt/
          
          # Copy GPG key to root
          cp /tmp/pds-repo.gpg pages/pds-repo.gpg
          
          # Copy logo and index page template
          cp .github/pages/logo.png pages/logo.png
          sed -e "s/{{REPO_OWNER}}/${{ github.repository_owner }}/g" \
              -e "s|{{REPO}}|${{ github.repository }}|g" \
              .github/pages/index.html > pages/index.html
          
          echo "Pages directory prepared:"
          ls -la pages/
      - name: Upload pages artifact
        uses: actions/upload-pages-artifact@v4
        with:
          path: pages
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

  # build-apt-repo-container:
  #   name: Build APT Repository Container
  #   runs-on: ubuntu-latest
  #   needs: [version, release]
  #   if: github.ref == 'refs/heads/main' && (github.event_name == 'push' || github.event_name == 'workflow_dispatch')
  #   steps:
  #     - name: Checkout
  #       uses: actions/checkout@v6
  #     - name: Download package for Docker build
  #       uses: actions/download-artifact@v7
  #       with:
  #         name: ${{ env.PACKAGE_NAME }}-${{ needs.version.outputs.semVer }}-all
  #         path: ./packaging/dist
  #     - name: Build and push Docker image
  #       uses: michielvha/docker-release-action@main
  #       with:
  #         version: ${{ needs.version.outputs.semVer }}
  #         username: ${{ secrets.DOCKER_USERNAME }}
  #         password: ${{ secrets.DOCKER_PASSWORD }}
  #         project: pds-apt-repo
  #         platforms: linux/amd64,linux/arm64
  #         context: ./packaging
  #         build-args: |
  #           VERSION=${{ needs.version.outputs.semVer }}
  #           BUILD_DATE=${{ github.event.head_commit.timestamp }}
  #           VCS_REF=${{ github.sha }}

# TODO: look into using aptly and hosting the files either on gh pages or edgeforge.eu so we can actually distribute this 
# Optional: Auto-update APT repository
# deploy-repo:
#   name: Update APT Repository
#   runs-on: ubuntu-latest
#   needs: [version, release]
#   if: startsWith(github.ref, 'refs/tags/v')
#   steps:
#     - name: Deploy to APT repository
#       run: |
#         # Add your APT repository update logic here
#         # This could involve aptly, reprepro, or a hosted service API
#         echo "Would update APT repository here"
# community option for releasing




# TODO: look into this one because it auto generates the release notes might solve our issue in the TODO above.
# - name: Create Release
#   uses: softprops/action-gh-release@v2
#   with:
#     tag_name: v${{ needs.version.outputs.semVer }}
#     name: PDS v${{ needs.version.outputs.semVer }}
#     body_path: release-notes.md
#     files: |
#       ./release/*.deb
#     generate_release_notes: true
#     make_latest: true
#     draft: false
#     prerelease: false

