#!/bin/bash
# PDS Functions CLI Helper
# Usage: pds [command] [options]

set -euo pipefail

PDS_LIB_DIR="${PDS_LIB_DIR:-/usr/share/pds}"

# Read version from file if available, fallback to default
if [ -r "${PDS_LIB_DIR}/VERSION" ]; then
    PDS_VERSION="$(cat "${PDS_LIB_DIR}/VERSION")"
else
    PDS_VERSION="dev"
fi

# Function to show help
show_help() {
    cat << 'EOF'
PDS (Personal Development Scripts) CLI Helper

USAGE:
    pds <command> [options]

COMMANDS:
    help, -h, --help    Show this help message
    list                List all available functions
    info                Show PDS installation information
    load                Manually load PDS functions in current shell
    doctor              Check PDS installation health
    search <term>       Search for functions containing term
    show <function>     Show function source code

FUNCTION CATEGORIES:
    Software Installation:
        install_docker, install_vscode, install_kubectl, etc.
    
    HashiCorp Tools:
        install_hashicorp_product, install_packer
    
    UI/Theme Setup:
        install_jetbrains_font, install_tokyonight_theme, setup_gnome_extras
    
    Shell Configuration:
        install_ohmyzsh, configure_ohmyzsh, install_zsh_extensions

EXAMPLES:
    pds list                    # List all functions
    pds search docker          # Find Docker-related functions
    pds show install_docker    # Show install_docker function source
    pds doctor                  # Check installation

To disable auto-loading: export PDS_DISABLE=1
To re-enable: unset PDS_DISABLE

More info: https://github.com/michielvha/PDS
EOF
}

# Function to list all available functions
list_functions() {
    echo "Available PDS Functions:"
    echo "========================"
    
    if [ ! -d "$PDS_LIB_DIR" ]; then
        echo "Error: PDS library directory not found: $PDS_LIB_DIR"
        return 1
    fi
    
    local category_count=0
    
    # List debian functions
    if [ -d "$PDS_LIB_DIR/debian" ]; then
        echo
        echo "Platform: Debian"
        echo "================"
        
        # List all subdirectories in debian
        for category_dir in "$PDS_LIB_DIR/debian"/*; do
            if [ -d "$category_dir" ]; then
                local category_name script_count
                category_name=$(basename "$category_dir")
                script_count=$(find "$category_dir" -maxdepth 1 -name "*.sh" -type f | wc -l)
                
                if [ "$script_count" -gt 0 ]; then
                    echo
                    echo "Category: $category_name"
                    echo "$(printf -- '-%.0s' $(seq 1 $((${#category_name} + 10))))"
                    
                    # List all scripts in this category
                    for script in "$category_dir"/*.sh; do
                        if [ -f "$script" ]; then
                            echo "  $(basename "$script" .sh)"
                        fi
                    done
                    category_count=$((category_count + 1))
                fi
            fi
        done
    fi
    
    # List common functions
    if [ -d "$PDS_LIB_DIR/common" ]; then
        echo
        echo "Platform: Common"
        echo "================"
        
        # List all subdirectories in common
        for category_dir in "$PDS_LIB_DIR/common"/*; do
            if [ -d "$category_dir" ]; then
                local category_name script_count
                category_name=$(basename "$category_dir")
                script_count=$(find "$category_dir" -maxdepth 1 -name "*.sh" -type f | wc -l)
                
                if [ "$script_count" -gt 0 ]; then
                    echo
                    echo "Category: $category_name"
                    echo "$(printf -- '-%.0s' $(seq 1 $((${#category_name} + 10))))"
                    
                    # List all scripts in this category
                    for script in "$category_dir"/*.sh; do
                        if [ -f "$script" ]; then
                            echo "  $(basename "$script" .sh)"
                        fi
                    done
                    category_count=$((category_count + 1))
                fi
            fi
        done
    fi
    
    echo
    echo "Total categories: $category_count"
}

# Function to search for functions
search_functions() {
    local search_term="$1"
    if [ -z "$search_term" ]; then
        echo "Error: Please provide a search term"
        return 1
    fi
    
    echo "Searching for functions containing: $search_term"
    echo "================================================"
    
    local found_any=false
    
    # Search in debian directory
    if [ -d "$PDS_LIB_DIR/debian" ]; then
        for category_dir in "$PDS_LIB_DIR/debian"/*; do
            if [ -d "$category_dir" ]; then
                local category_name
                category_name=$(basename "$category_dir")
                
                for script in "$category_dir"/*.sh; do
                    if [ -f "$script" ]; then
                        local script_name
                        script_name=$(basename "$script" .sh)
                        
                        local matches
                        matches=$(grep -i -E "(function.*$search_term|$search_term.*\(\)|#.*$search_term)" "$script" 2>/dev/null || true)
                        
                        if [ -n "$matches" ]; then
                            echo
                            echo "In debian/$category_name/$script_name:"
                            echo "$matches" | while IFS= read -r line; do
                                echo "  $line"
                            done
                            found_any=true
                        fi
                    fi
                done
            fi
        done
    fi
    
    # Search in common directory
    if [ -d "$PDS_LIB_DIR/common" ]; then
        for category_dir in "$PDS_LIB_DIR/common"/*; do
            if [ -d "$category_dir" ]; then
                local category_name
                category_name=$(basename "$category_dir")
                
                for script in "$category_dir"/*.sh; do
                    if [ -f "$script" ]; then
                        local script_name
                        script_name=$(basename "$script" .sh)
                        
                        local matches
                        matches=$(grep -i -E "(function.*$search_term|$search_term.*\(\)|#.*$search_term)" "$script" 2>/dev/null || true)
                        
                        if [ -n "$matches" ]; then
                            echo
                            echo "In common/$category_name/$script_name:"
                            echo "$matches" | while IFS= read -r line; do
                                echo "  $line"
                            done
                            found_any=true
                        fi
                    fi
                done
            fi
        done
    fi
    
    if [ "$found_any" = false ]; then
        echo "No matches found for: $search_term"
    fi
}

# Function to show function source
show_function() {
    local func_name="$1"
    if [ -z "$func_name" ]; then
        echo "Error: Please provide a function name"
        return 1
    fi
    
    echo "Source code for function: $func_name"
    echo "====================================="
    
    local found=false
    
    # Search in debian directories
    if [ -d "$PDS_LIB_DIR/debian" ]; then
        for category_dir in "$PDS_LIB_DIR/debian"/*; do
            if [ -d "$category_dir" ]; then
                local category_name
                category_name=$(basename "$category_dir")
                
                for script in "$category_dir"/*.sh; do
                    if [ -f "$script" ] && grep -q "^[[:space:]]*${func_name}[[:space:]]*(" "$script" 2>/dev/null; then
                        local script_name
                        script_name=$(basename "$script" .sh)
                        echo "Found in debian/$category_name/$script_name"
                        echo "File: $script"
                        echo
                        
                        awk "/^[[:space:]]*${func_name}[[:space:]]*\(/,/^}/" "$script"
                        found=true
                        break 3
                    fi
                done
            fi
        done
    fi
    
    # Search in common directories if not found
    if [ "$found" = false ] && [ -d "$PDS_LIB_DIR/common" ]; then
        for category_dir in "$PDS_LIB_DIR/common"/*; do
            if [ -d "$category_dir" ]; then
                local category_name
                category_name=$(basename "$category_dir")
                
                for script in "$category_dir"/*.sh; do
                    if [ -f "$script" ] && grep -q "^[[:space:]]*${func_name}[[:space:]]*(" "$script" 2>/dev/null; then
                        local script_name
                        script_name=$(basename "$script" .sh)
                        echo "Found in common/$category_name/$script_name"
                        echo "File: $script"
                        echo
                        
                        awk "/^[[:space:]]*${func_name}[[:space:]]*\(/,/^}/" "$script"
                        found=true
                        break 3
                    fi
                done
            fi
        done
    fi
    
    if [ "$found" = false ]; then
        echo "Function '$func_name' not found in any PDS library."
        return 1
    fi
}

# Function to check installation
doctor_check() {
    echo "PDS Installation Health Check"
    echo "============================="
    echo
    
    local issues=0
    
    # Check if init script exists
    if [ -f /usr/share/pds/init.sh ]; then
        echo "✅ Init script found: /usr/share/pds/init.sh"
    else
        echo "❌ Init script missing: /usr/share/pds/init.sh"
        ((issues++))
    fi
    
    # Check if profile.d script exists
    if [ -f /etc/profile.d/pds.sh ]; then
        echo "✅ Profile script found: /etc/profile.d/pds.sh"
    else
        echo "❌ Profile script missing: /etc/profile.d/pds.sh"
        ((issues++))
    fi
    
    # Check library directory
    if [ -d "$PDS_LIB_DIR" ]; then
        echo "✅ Library directory found: $PDS_LIB_DIR"
        
        # Count debian functions
        if [ -d "$PDS_LIB_DIR/debian" ]; then
            local debian_count
            debian_count=$(find "$PDS_LIB_DIR/debian" -name "*.sh" -type f | wc -l)
            echo "   - Debian functions: $debian_count"
        fi
        
        # Count common functions
        if [ -d "$PDS_LIB_DIR/common" ]; then
            local common_count
            common_count=$(find "$PDS_LIB_DIR/common" -name "*.sh" -type f | wc -l)
            echo "   - Common functions: $common_count"
        fi
    else
        echo "❌ Library directory missing: $PDS_LIB_DIR"
        ((issues++))
    fi
    
    # Check if functions are loaded - try some common function names
    local functions_loaded=false
    
    # Check for functions that should exist
    if declare -f detect_distro >/dev/null 2>&1 || \
       declare -f install_docker >/dev/null 2>&1; then
        functions_loaded=true
    fi
    
    if [ "$functions_loaded" = true ]; then
        echo "✅ Functions are loaded in current shell"
    else
        echo "⚠️  Functions not loaded in current shell (run 'source /usr/share/pds/init.sh')"
    fi
    
    # Check environment variables
    if [ -n "${PDS_DISABLE:-}" ]; then
        echo "⚠️  PDS auto-loading is disabled (PDS_DISABLE=$PDS_DISABLE)"
    else
        echo "✅ PDS auto-loading is enabled"
    fi
    
    echo
    if [ "$issues" -eq 0 ]; then
        echo "✅ PDS installation appears healthy!"
    else
        echo "❌ Found $issues issue(s). Consider reinstalling PDS package."
        return 1
    fi
}

# Function to manually load PDS
load_pds() {
    if [ -f /usr/share/pds/init.sh ]; then
        # shellcheck disable=SC1091
        source /usr/share/pds/init.sh
        echo "✅ PDS functions loaded successfully!"
    else
        echo "❌ PDS init script not found. Is PDS installed?"
        return 1
    fi
}

# Function to show info
show_info() {
    echo "PDS (Personal Development Scripts) v${PDS_VERSION}"
    echo "================================================="
    echo "Installation path: /usr/share/pds/"
    echo "Library path: $PDS_LIB_DIR"
    echo "Profile script: /etc/profile.d/pds.sh"
    echo
    echo "GitHub: https://github.com/michielvha/PDS"
    echo
    if [ -d "$PDS_LIB_DIR" ]; then
        echo "Installed function categories:"
        
        # Show debian functions
        if [ -d "$PDS_LIB_DIR/debian" ]; then
            local debian_total=0
            echo "  - Debian:"
            for category_dir in "$PDS_LIB_DIR/debian"/*; do
                if [ -d "$category_dir" ]; then
                    local category_name
                    category_name=$(basename "$category_dir")
                    local category_count
                    category_count=$(find "$category_dir" -maxdepth 1 -name "*.sh" -type f | wc -l)
                    
                    if [ "$category_count" -gt 0 ]; then
                        echo "    └── $category_name: $category_count"
                        debian_total=$((debian_total + category_count))
                    fi
                fi
            done
            echo "    Total debian functions: $debian_total"
        fi
        
        # Show common functions
        if [ -d "$PDS_LIB_DIR/common" ]; then
            local common_total=0
            echo "  - Common:"
            for category_dir in "$PDS_LIB_DIR/common"/*; do
                if [ -d "$category_dir" ]; then
                    local category_name
                    category_name=$(basename "$category_dir")
                    local category_count
                    category_count=$(find "$category_dir" -maxdepth 1 -name "*.sh" -type f | wc -l)
                    
                    if [ "$category_count" -gt 0 ]; then
                        echo "    └── $category_name: $category_count"
                        common_total=$((common_total + category_count))
                    fi
                fi
            done
            echo "    Total common functions: $common_total"
        fi
    fi
}

# Main command handling
case "${1:-help}" in
    help|-h|--help)
        show_help
        ;;
    list)
        list_functions
        ;;
    info)
        show_info
        ;;
    load)
        load_pds
        ;;
    doctor)
        doctor_check
        ;;
    search)
        if [ $# -lt 2 ]; then
            echo "Error: search requires a search term"
            echo "Usage: pds search <term>"
            exit 1
        fi
        search_functions "$2"
        ;;
    show)
        if [ $# -lt 2 ]; then
            echo "Error: show requires a function name"
            echo "Usage: pds show <function_name>"
            exit 1
        fi
        show_function "$2"
        ;;
    *)
        echo "Unknown command: $1"
        echo "Run 'pds help' for usage information."
        exit 1
        ;;
esac
